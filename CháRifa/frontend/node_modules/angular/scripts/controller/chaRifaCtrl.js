angular.module("chaRifa").controller("chaRifaCtrl", function ($scope, $timeout, addUser) {

    // VAI ARMAZENAR A LISTA OS NUMEROS 1 A 100
    $scope.listNumber = []; 

    // VAI ARMAZENAR OS NUMEROS ESCOLHIDOS
    $scope.selectedNumber = [];

     
    // ARMAZENAR AS INFROMAÇÕES DO USER
    $scope.user = {};


    // FAZ UM LOOP FINITO OS 
    for (let cont = 1; cont <= 100; cont++) {
        $scope.listNumber.push(cont.toString().padStart(2, '0'));
    }

    // MODAL DAS INFORAMÇÕES COMEÇA FALSE (DESATIVADO)
    $scope.modalAberto = false;

     // Função para abrir o modal
    $scope.abrirModal = function() {
      $scope.modalAberto = true;
    };

     // Função para fechar o modal
    $scope.fecharModal = function() {
      $scope.modalAberto = false;
    };

    // Mostrar automaticamente ao carregar o modal das informações
    $timeout(function() {
      $scope.modalAberto = true;
    }, 0)

    // PEGA OS NÚMEROS JÁ ESCOLHIDOS DO BACK-END
    // addUser.getUsers().then(function(response) {
    //   $scope.selectedNumber = response.data.map(function(item) {
    //       return item.number;
    //   });
    // });


    // PEGA OS NÚMEROS JÁ ESCOLHIDOS DO BACK-END
    firebase.database().ref("rifas").once("value").then(function(snapshot) {
      const data = snapshot.val() || {};
      const numerosEscolhidos = Object.values(data).map(function(item) {
        return item.number;
      });
      $scope.selectedNumber = numerosEscolhidos;
      $scope.$apply(); // atualiza o Angular depois do .then
    });

    // MODAL PARA ABRIR UM NUMERO ESCOLHIDO (DESATIVADO)
    $scope.showModalNumber = false;
    
    // MODAL ABERTO DO NUMERO ESCOLHIDO
    $scope.open = function (number) {
      $scope.choiceNumer = number;
      $scope.showModalNumber = true;

      // FAZ A VALIDAÇÃO DE TAMANHOS DA FRALDA A PARTIR DE UM NUMEROS
      if ($scope.choiceNumer <= 10) {
        $scope.size = 'P';
      } else if ($scope.choiceNumer <= 50) {
        $scope.size = 'M';
      } else {
        $scope.size = 'G';
      }
    }

    // FECHAR MODAL DA ESCOLHA DOS NUMEROS
    $scope.closerModalNumber = function() {
      $scope.showModalNumber = false;
    }


    
    // Função para confirmar a escolha e salvar os dados
    $scope.confirm = function () {
     
      if($scope.user.name && $scope.user.email && $scope.user.tel) {
        const dados = {
          number: $scope.choiceNumer,
          name: $scope.user.name,
          email: $scope.user.email,
          tel: $scope.user.tel
        };
        
        // Salvar no Firebase
        const db = firebase.database();
        const ref = db.ref("rifas/numero_" + $scope.choiceNumer);
        
        ref.set(dados, function(error) {
          if (error) {
            console.log("Erro ao salvar:", error);
          } else {
            console.log("Dados salvos com sucesso!");

            $scope.$apply(function () {
              // Marca como escolhido
              $scope.selectedNumber.push($scope.choiceNumer);
              $scope.showModalNumber = false;
              $scope.user = {}; // Limpa os campos do formulário
            }) 
          }
        });
      }
    };


    $scope.isDisabled = function (number) {
      return $scope.selectedNumber.includes(number);
    };

    // FOOTER
    $scope.titleFooter =  "Mariana Santos";
   
})